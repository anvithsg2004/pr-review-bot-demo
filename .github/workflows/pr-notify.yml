name: PR Review Notification

on:
  pull_request:
    types: [opened, reopened, review_requested, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-notify-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  notify-slack:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build and Send Notification
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const https = require('https');

            const config = JSON.parse(
              fs.readFileSync('.github/config/team-config.json', 'utf8')
            );

            const pr = context.payload.pull_request;

            // ========================================
            // GATHER PR INFO
            // ========================================
            const authorConfig = config.team_members[pr.user.login];
            const authorMention = authorConfig
              ? `<@${authorConfig.slack_id}>`
              : pr.user.login;

            const reviewerMentions = pr.requested_reviewers.map(r => {
              const member = config.team_members[r.login];
              return member ? `<@${member.slack_id}>` : `@${r.login}`;
            }).join(' ') || 'None assigned';

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const totalChanges = additions + deletions;

            let size = 'Small';
            if (totalChanges > 500) size = 'Large';
            else if (totalChanges > 200) size = 'Medium';

            const fileNames = files.map(f => f.filename).join(', ');

            const cleanBody = (pr.body || 'No description provided')
              .substring(0, 300)
              .replace(/`/g, '')
              .replace(/\n/g, ' ')
              .replace(/\r/g, '')
              .replace(/#/g, '')
              .replace(/\*/g, '')
              .trim();

            console.log('PR Title:', pr.title);
            console.log('Author:', pr.user.login);
            console.log('Size:', size);
            console.log('Files:', fileNames);

            // ========================================
            // GEMINI API HELPER
            // ========================================
            async function callGemini(prompt) {
              const apiKey = process.env.GEMINI_API_KEY;
              if (!apiKey) {
                console.log('No Gemini API key');
                return null;
              }

              const url = '/v1beta/models/gemini-2.5-flash:generateContent?key=' + apiKey;

              const body = JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 300
                }
              });

              return new Promise((resolve) => {
                const req = https.request({
                  hostname: 'generativelanguage.googleapis.com',
                  path: url,
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                }, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => {
                    try {
                      const parsed = JSON.parse(data);
                      if (parsed.error) {
                        console.log('Gemini error:', parsed.error.message);
                        resolve(null);
                        return;
                      }
                      if (parsed.candidates &&
                          parsed.candidates[0] &&
                          parsed.candidates[0].content &&
                          parsed.candidates[0].content.parts &&
                          parsed.candidates[0].content.parts[0]) {
                        resolve(parsed.candidates[0].content.parts[0].text.trim());
                      } else {
                        console.log('Unexpected response:', JSON.stringify(parsed).substring(0, 300));
                        resolve(null);
                      }
                    } catch (e) {
                      console.log('Parse error:', e.message);
                      resolve(null);
                    }
                  });
                });
                req.on('error', (e) => {
                  console.log('Request error:', e.message);
                  resolve(null);
                });
                req.write(body);
                req.end();
              });
            }

            // ========================================
            // GENERATE AI MESSAGE
            // ========================================
            const prompt = [
              'You are a Slack notification bot for a software development team.',
              'Write exactly 2 to 3 sentences to inform the team that a new pull request has been created and needs their review.',
              '',
              'Pull request details:',
              'Title: ' + pr.title,
              'Author: ' + pr.user.login,
              'Branch: ' + pr.head.ref + ' merging into ' + pr.base.ref,
              'Size: ' + size + ' with ' + additions + ' lines added and ' + deletions + ' lines deleted',
              'Files changed: ' + files.length,
              'File names: ' + fileNames,
              'Description: ' + cleanBody,
              '',
              'Rules:',
              '1. Write exactly 2 to 3 complete sentences',
              '2. Briefly describe what the PR changes',
              '3. Estimate review time based on size',
              '4. Ask the team to review',
              '5. Friendly and professional tone',
              '6. No emojis',
              '7. No links or URLs',
              '8. No markdown formatting at all',
              '9. Plain English text only',
              '10. Output ONLY the message text'
            ].join('\n');

            console.log('Calling Gemini...');
            const aiResponse = await callGemini(prompt);

            let aiMessage = '';

            if (aiResponse) {
              aiMessage = aiResponse
                .replace(/\*/g, '')
                .replace(/`/g, '')
                .replace(/_/g, ' ')
                .replace(/~/g, '')
                .replace(/#/g, '')
                .replace(/\n+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

              console.log('AI response:', aiMessage);
              console.log('Length:', aiMessage.length);

              if (aiMessage.length < 50) {
                console.log('Too short, using fallback');
                aiMessage = '';
              }
            } else {
              console.log('AI returned null');
            }

            if (!aiMessage) {
              aiMessage = 'A new pull request has been opened for ' + pr.title +
                '. It is a ' + size.toLowerCase() + ' change with ' +
                additions + ' lines added across ' + files.length +
                ' file(s). Please review when you get a chance.';
              console.log('Fallback:', aiMessage);
            }

            // ========================================
            // BUILD SLACK PAYLOAD (all in JavaScript)
            // ========================================
            const payload = {
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "Pull Request — Review Requested",
                    emoji: false
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `*<${pr.html_url}|#${pr.number}: ${pr.title}>*`
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "plain_text",
                    text: aiMessage,
                    emoji: false
                  }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: `*Author:*\n${authorMention}` },
                    { type: "mrkdwn", text: `*Reviewers:*\n${reviewerMentions}` },
                    { type: "mrkdwn", text: `*Branch:*\n\`${pr.head.ref}\` into \`${pr.base.ref}\`` },
                    { type: "mrkdwn", text: `*Size:*\n${size}` },
                    { type: "mrkdwn", text: `*Files Changed:*\n${files.length}` },
                    { type: "mrkdwn", text: `*Lines Changed:*\n+${additions} / -${deletions}` }
                  ]
                },
                { type: "divider" },
                {
                  type: "context",
                  elements: [{
                    type: "mrkdwn",
                    text: "Severity: *LOW* | Reminders will follow if review remains pending"
                  }]
                },
                {
                  type: "actions",
                  elements: [
                    {
                      type: "button",
                      text: { type: "plain_text", text: "Review PR", emoji: false },
                      url: pr.html_url + '/files',
                      style: "primary"
                    },
                    {
                      type: "button",
                      text: { type: "plain_text", text: "View Discussion", emoji: false },
                      url: pr.html_url
                    }
                  ]
                }
              ]
            };

            // ========================================
            // SEND TO SLACK (directly from JavaScript)
            // ========================================
            const webhookUrl = new URL(process.env.SLACK_WEBHOOK_URL);

            const slackResult = await new Promise((resolve, reject) => {
              const req = https.request({
                hostname: webhookUrl.hostname,
                path: webhookUrl.pathname,
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              });
              req.on('error', reject);
              req.write(JSON.stringify(payload));
              req.end();
            });

            console.log('Slack response:', slackResult);

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `**Slack Notification Sent**\n\n` +
                    `A review request has been posted to Slack.\n\n` +
                    `**Escalation Timeline (Demo Mode):**\n` +
                    `- 0–15 min: Channel notification (LOW)\n` +
                    `- 15–30 min: MEDIUM severity\n` +
                    `- 30–45 min: HIGH severity\n` +
                    `- 45+ min: CRITICAL severity\n`
            });