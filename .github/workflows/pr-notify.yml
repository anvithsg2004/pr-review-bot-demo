name: PR Review Notification

on:
  pull_request:
    types: [opened, reopened, review_requested, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-notify-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  notify-slack:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Gather PR Information
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const config = JSON.parse(
              fs.readFileSync('.github/config/team-config.json', 'utf8')
            );

            const pr = context.payload.pull_request;

            const authorConfig = config.team_members[pr.user.login];
            const authorMention = authorConfig
              ? `<@${authorConfig.slack_id}>`
              : pr.user.login;

            const reviewerMentions = pr.requested_reviewers.map(r => {
              const member = config.team_members[r.login];
              return member ? `<@${member.slack_id}>` : `@${r.login}`;
            }).join(' ') || 'None assigned';

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const totalChanges = additions + deletions;

            let size = 'Small';
            if (totalChanges > 500) size = 'Large';
            else if (totalChanges > 200) size = 'Medium';

            const fileNames = files.map(f => f.filename).join(', ');

            // Sanitize description — remove backticks and special chars
            const rawBody = (pr.body || 'No description provided').substring(0, 300);
            const cleanBody = rawBody
              .replace(/`/g, '')
              .replace(/\n/g, ' ')
              .replace(/\r/g, '')
              .replace(/"/g, "'")
              .replace(/#/g, '')
              .replace(/\*/g, '')
              .replace(/\|/g, '-')
              .trim();

            core.setOutput('pr_number', pr.number);
            core.setOutput('title', pr.title);
            core.setOutput('url', pr.html_url);
            core.setOutput('author', pr.user.login);
            core.setOutput('author_mention', authorMention);
            core.setOutput('reviewer_mentions', reviewerMentions);
            core.setOutput('branch', pr.head.ref);
            core.setOutput('base', pr.base.ref);
            core.setOutput('files_changed', files.length);
            core.setOutput('additions', additions);
            core.setOutput('deletions', deletions);
            core.setOutput('size', size);
            core.setOutput('file_names', fileNames);
            core.setOutput('body', cleanBody);

      - name: Generate AI Message
        id: ai-message
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_TITLE: ${{ steps.pr-info.outputs.title }}
          PR_AUTHOR: ${{ steps.pr-info.outputs.author }}
          PR_BRANCH: ${{ steps.pr-info.outputs.branch }}
          PR_BASE: ${{ steps.pr-info.outputs.base }}
          PR_SIZE: ${{ steps.pr-info.outputs.size }}
          PR_ADDITIONS: ${{ steps.pr-info.outputs.additions }}
          PR_DELETIONS: ${{ steps.pr-info.outputs.deletions }}
          PR_FILES_CHANGED: ${{ steps.pr-info.outputs.files_changed }}
          PR_FILE_NAMES: ${{ steps.pr-info.outputs.file_names }}
          PR_BODY: ${{ steps.pr-info.outputs.body }}
        with:
          script: |
            const https = require('https');

            async function callGemini(prompt) {
              const apiKey = process.env.GEMINI_API_KEY;
              const url = `/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

              const requestBody = JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 200
                }
              });

              return new Promise((resolve) => {
                const req = https.request({
                  hostname: 'generativelanguage.googleapis.com',
                  path: url,
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                }, (res) => {
                  let data = '';
                  res.on('data', chunk => data += chunk);
                  res.on('end', () => {
                    try {
                      const parsed = JSON.parse(data);
                      if (parsed.candidates && parsed.candidates[0]) {
                        const text = parsed.candidates[0].content.parts[0].text;
                        resolve(text.trim());
                      } else {
                        console.log('Gemini response:', data);
                        resolve(null);
                      }
                    } catch (e) {
                      console.log('Parse error:', e.message);
                      resolve(null);
                    }
                  });
                });
                req.on('error', (e) => {
                  console.log('Request error:', e.message);
                  resolve(null);
                });
                req.write(requestBody);
                req.end();
              });
            }

            // Build prompt using environment variables (safe from special chars)
            const prompt = [
              'You are a helpful Slack bot for a software engineering team.',
              'Generate a short, professional message (2-3 sentences) to notify the team about a new pull request that needs review.',
              '',
              'PR Details:',
              '- Title: ' + process.env.PR_TITLE,
              '- Author: ' + process.env.PR_AUTHOR,
              '- Branch: ' + process.env.PR_BRANCH + ' into ' + process.env.PR_BASE,
              '- Size: ' + process.env.PR_SIZE + ' (' + process.env.PR_ADDITIONS + ' additions, ' + process.env.PR_DELETIONS + ' deletions)',
              '- Files changed: ' + process.env.PR_FILES_CHANGED,
              '- Files: ' + process.env.PR_FILE_NAMES,
              '- Description: ' + process.env.PR_BODY,
              '',
              'Rules:',
              '- Keep it concise and friendly',
              '- Mention what the PR is about based on the title and files',
              '- Suggest how long the review might take based on size',
              '- Do NOT use emojis',
              '- Do NOT include the PR link (it will be added separately)',
              '- Do NOT use markdown formatting like bold, italic, backticks, or asterisks',
              '- Write in plain text only, 2-3 sentences max'
            ].join('\n');

            console.log('Prompt built successfully');

            const aiMessage = await callGemini(prompt);

            if (aiMessage) {
              // Clean AI response of any markdown it might include
              const cleanMessage = aiMessage
                .replace(/\*/g, '')
                .replace(/`/g, '')
                .replace(/_/g, '')
                .replace(/~/g, '')
                .replace(/\n/g, ' ')
                .trim();

              console.log('AI generated message:', cleanMessage);
              core.setOutput('message', cleanMessage);
              core.setOutput('has_ai', 'true');
            } else {
              const fallback = 'A new pull request has been opened and is ready for review.';
              console.log('Using fallback message');
              core.setOutput('message', fallback);
              core.setOutput('has_ai', 'false');
            }

      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Pull Request — Review Requested",
                    "emoji": false
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*<${{ steps.pr-info.outputs.url }}|#${{ steps.pr-info.outputs.pr_number }}: ${{ steps.pr-info.outputs.title }}>*"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.ai-message.outputs.message }}",
                    "emoji": false
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ steps.pr-info.outputs.author_mention }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Reviewers:*\n${{ steps.pr-info.outputs.reviewer_mentions }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ steps.pr-info.outputs.branch }}` into `${{ steps.pr-info.outputs.base }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Size:*\n${{ steps.pr-info.outputs.size }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Files Changed:*\n${{ steps.pr-info.outputs.files_changed }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Lines Changed:*\n+${{ steps.pr-info.outputs.additions }} / -${{ steps.pr-info.outputs.deletions }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Severity: *LOW* | Reminders will follow if review remains pending"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Review PR",
                        "emoji": false
                      },
                      "url": "${{ steps.pr-info.outputs.url }}/files",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Discussion",
                        "emoji": false
                      },
                      "url": "${{ steps.pr-info.outputs.url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `**Slack Notification Sent**\n\n` +
                    `A review request has been posted to Slack.\n\n` +
                    `**Escalation Timeline (Demo Mode):**\n` +
                    `- 0–15 min: Channel notification (LOW)\n` +
                    `- 15–30 min: MEDIUM severity\n` +
                    `- 30–45 min: HIGH severity\n` +
                    `- 45+ min: CRITICAL severity\n`
            });