name: PR Review Notification

on:
  pull_request:
    types: [opened, reopened, review_requested, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-notify-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  notify-slack:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Gather PR Information
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const config = JSON.parse(
              fs.readFileSync('.github/config/team-config.json', 'utf8')
            );

            const pr = context.payload.pull_request;

            // Get reviewers
            const reviewers = pr.requested_reviewers
              .map(r => r.login).join(', ') || 'None assigned';

            // Map author to Slack
            const authorConfig = config.team_members[pr.user.login];
            const authorMention = authorConfig
              ? `<@${authorConfig.slack_id}>`
              : pr.user.login;

            // Map reviewers to Slack
            const reviewerMentions = pr.requested_reviewers.map(r => {
              const member = config.team_members[r.login];
              return member ? `<@${member.slack_id}>` : `@${r.login}`;
            }).join(' ') || 'None assigned';

            // Get file stats
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const totalChanges = additions + deletions;

            let size = 'Small';
            if (totalChanges > 500) size = 'Large';
            else if (totalChanges > 200) size = 'Medium';

            // Set all outputs
            core.setOutput('pr_number', pr.number);
            core.setOutput('title', pr.title);
            core.setOutput('url', pr.html_url);
            core.setOutput('author', pr.user.login);
            core.setOutput('author_mention', authorMention);
            core.setOutput('reviewer_mentions', reviewerMentions);
            core.setOutput('branch', pr.head.ref);
            core.setOutput('base', pr.base.ref);
            core.setOutput('files_changed', files.length);
            core.setOutput('additions', additions);
            core.setOutput('deletions', deletions);
            core.setOutput('size', size);
            core.setOutput('body', (pr.body || 'No description').substring(0, 200));

      - name: Send Slack Notification
        id: slack
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Pull Request — Review Requested",
                    "emoji": false
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*<${{ steps.pr-info.outputs.url }}|#${{ steps.pr-info.outputs.pr_number }}: ${{ steps.pr-info.outputs.title }}>*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ steps.pr-info.outputs.author_mention }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Reviewers:*\n${{ steps.pr-info.outputs.reviewer_mentions }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ steps.pr-info.outputs.branch }}` into `${{ steps.pr-info.outputs.base }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Size:*\n${{ steps.pr-info.outputs.size }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Files Changed:*\n${{ steps.pr-info.outputs.files_changed }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Lines Changed:*\n+${{ steps.pr-info.outputs.additions }} / -${{ steps.pr-info.outputs.deletions }}"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Severity: *LOW* | Reminders will follow if review remains pending"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Review PR",
                        "emoji": false
                      },
                      "url": "${{ steps.pr-info.outputs.url }}/files",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Discussion",
                        "emoji": false
                      },
                      "url": "${{ steps.pr-info.outputs.url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `**Slack Notification Sent**\n\n` +
                    `A review request has been posted to Slack.\n\n` +
                    `**Escalation Timeline (Demo Mode):**\n` +
                    `- 0–5 min: Channel notification (LOW)\n` +
                    `- 5–10 min: MEDIUM severity\n` +
                    `- 10–20 min: HIGH severity\n` +
                    `- 20+ min: CRITICAL severity\n`
            });